---
import Airtable from 'airtable';

// --- La parte getStaticPaths rimane INVARIATA ---
export async function getStaticPaths() {
  const base = new Airtable({
    apiKey: import.meta.env.PUBLIC_AIRTABLE_API_KEY
  }).base(import.meta.env.PUBLIC_AIRTABLE_BASE_ID);

  const records = await base(import.meta.env.PUBLIC_AIRTABLE_TABLE_NAME).select().all();

  return records.map(record => {
    return {
      params: { id: record.id },
      props: {
        item: {
          name: record.fields.Name,
          description: record.fields.Description,
          image: record.fields.Edited?.[0]?.url,
          category: record.fields.Category,
          region: record.fields.Region,
          producers: record.fields.Producers,
          seasonality: record.fields.Seasonality,
        }
      },
    };
  });
}

const { item } = Astro.props;

// --- INIZIO LOGICA RICETTE (Aggiornata) ---
// Queste tre ricette appariranno per OGNI prodotto.
const recipes = [
  "Decotto digestivo",
  "Linguine gamberetti, zucchine e zafferano",
  "Risotto allo zafferano e pancetta"
];
// --- FINE LOGICA RICETTE ---
---

<html lang="it">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width" />
  <meta name="generator" content={Astro.generator} />
  <title>{item ? item.name : 'Dettaglio Prodotto'}</title>

  <style>
    :root {
      --padding-main: 40px;
      --color-background: #d1c5ad;
      --color-text-dark: #4a3f35;
      --color-text-light: #6d5f53;
      --color-border: rgba(74, 63, 53, 0.5);
      --color-highlight-border: #21150f; 
    }

    ::selection {
      background: transparent;
      color: var(--color-highlight);
    }

    html {
      height: 100%;
    }

    body {
      background-color: var(--color-background);
      color: var(--color-text-dark);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.6;
      margin: 0;
      height: 100%;
      overflow: hidden; 
    }

    .details-layout {
      display: flex; 
      flex-direction: column;
      min-height: 100vh; 
      position: relative; 
    }

    /* --- SEZIONE HEADER --- */
    .main-header {
      color: #4a3f35;
      text-align: left;
      padding-top: 65px;
      padding-left: 20px;
      padding-right: 20px;
      padding-bottom: 6px;
      z-index: 10;
      position: relative;
      box-sizing: border-box;
    }

    .marquee-container {
      overflow: hidden; 
      width: 100%;
    }

    .main-header h1 {
      margin: 0;
      padding: 0;
    }

    .marquee-track {
      display: flex;
      white-space: nowrap;
      width: fit-content; 
      animation: marquee 15s linear infinite; 
    }

    .marquee-item {
      font-size: 3vw;
      font-weight: 600;
      line-height: 1;
      color: #21150f;
      text-transform: uppercase;
      padding-right: 2rem; 
    }


    .descrizione {
      font-size: 3vw;
      font-weight: 600;
      line-height: 1;
      color: #21150f;
      margin: 0;
      overflow-wrap: break-word; 
      padding: 0;
      padding-bottom: 6px;
      padding-top: 6px;
      border-bottom: 2px solid var(--color-border); 
      border-top: 2px solid var(--color-border); 
      border-color:#21150f; 
    }
    
    
    .content-wrapper {
      padding: 0px 20px 20px 20px;
      max-width: 1080;
      margin: 0 auto; 
      width: 100%;
      box-sizing: border-box; 
      position: relative; 
      flex-grow: 1; 
    }

    /* --- Stile Immagine --- */
    .main-image {
      position: relative; 
      z-index: 1; 
      max-width: 15%; 
      height: auto;
      object-fit: contain;
      mix-blend-mode: multiply;
      transform-origin: bottom right; 
      transition: transform 0.3s ease-out, mix-blend-mode 0.3s ease-out; 
    }

    .main-image:hover {
      transform: scale(3); 
      z-index: 999; 
      mix-blend-mode: normal; 
    }


    .back-link {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1em;
      color:#21150f;
      text-decoration: none;
      transition: transform 0.2s ease;
      z-index: 20;
    }
    .back-link:hover {
      transform: translateX(-5px);
    }
    
    .site-title {
      position:fixed;
      top: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 1em;
      font-weight: bold;
      color: #22140c;
      z-index: 1000;
      pointer-events: none; 
      margin-bottom: 0px;
      padding-bottom:0px;
    }

    /* --- Stili per la riga INFO (Corretto) --- */
    .info-row {
      display: flex;
      flex-direction: row; 
      flex-wrap: wrap; 
      column-gap: 2rem;
      row-gap: 0px; 
      margin: 0px; 
      padding-top: 6px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--color-border); 
      border-color:#21150f; 
    }

    .info-item {
      display: flex; 
      align-items: baseline; 
      gap: 0.5em; 
      margin: 0px;
      font-weight: 600;
      font-size: 1em;
      text-transform: uppercase;
      padding: 0px;
      color: var(--color-text-dark); 
      transition: color 0.2s ease-in-out; 
      line-height: 1.2;
    }

    .info-item:hover {
      color: var(--color-highlight-border); 
    }

    .info {
      margin: 0px;
      padding: 0px;
    }
    
    p { 
      margin: 0px;
      padding: 0px;
    }
    
    /* --- STILI PER BLOCCHI ACCORDION (Recipes & Producers) --- */
    
    .accordion-column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem; /* Ridotto lo spazio */
      max-width: 20%; /* Stretta la colonna */
      width: 100%;
    }

    .producers-block, .recipes-block {
      width: 100%;
    }

    .producers-title, .recipes-title {
      font-weight: 600;
      font-size: 1em;
      text-transform: uppercase;
      color: #21150f;
      margin: 0 0 0.25rem 0; 
      cursor: pointer;
      user-select: none; 
    }
    
    .producers-title::after, .recipes-title::after {
      content: '←'; 
      display: inline-block;
      margin-left: 0.25em;
      font-weight: bold;
      font-size: 1em;
      transition: transform 0.2s ease-out; 
      transform: rotate(0deg); 
    }
    
    .producers-title.active::after, .recipes-title.active::after {
      transform: rotate(-90deg); 
    }

    .producers-content, .recipes-content {
      margin: 0;
    }

    .producer-item, .recipe-item {
      padding-bottom: 6px;
      padding-top: 6px;
      border-bottom: 2px solid var(--color-border); 
      line-height: 1.4;
      color: var(--color-text-dark); 
      transition: color 0.2s ease-in-out; 
    }

    .producer-item:hover, .recipe-item:hover {
      color: var(--color-highlight-border); 
    }

    /* Regola divisa: questa rimuove il bordo per entrambi */
    .producer-item:last-child, .recipe-item:last-child {
      border-bottom: none; 
      padding-bottom: 0;
    }

    /* Regola aggiuntiva: aggiunge spazio SOLO a "add your recipe" */
    .recipe-item:last-child {
      padding-top: 1.5rem; 
    }
    
    .producers-block p:not(.producers-title), 
    .recipes-block p:not(.recipes-title) {
      margin: 0; 
    }

    /* --- CONTENITORE FOOTER --- */
    .footer-content {
      display: flex;
      justify-content: space-between; 
      align-items: flex-end; 
      width: 100%;
      box-sizing: border-box;
      padding-left: 20px; 
      padding-right: var(--padding-main);
      padding-bottom: var(--padding-main);
    }

    /* --- Animazione Marquee --- */
    @keyframes marquee {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-20%); } 
    }

  </style>
</head>
<body>
    {item ? (
      <main class="details-layout">
        
        <a href="/" class="back-link" title="Torna alla home">←</a>
        <div class="site-title">SLOW FOOD ARCHIVE</div>
        
        <div class="main-header">
          <div class="marquee-container">
            <h1>
              <div class="marquee-track">
                <span class="marquee-item">{item.name}</span>
                <span class="marquee-item" aria-hidden="true">{item.name}</span>
                <span class="marquee-item" aria-hidden="true">{item.name}</span>
                <span class="marquee-item" aria-hidden="true">{item.name}</span>
                <span class="marquee-item" aria-hidden="true">{item.name}</span>
              </div>
            </h1>
          </div>
        </div>

        <div class="content-wrapper">

          <div>
            <p class="descrizione">{item.description}</p>
          </div>

          <div class="info-row">
            <div class="info-item">
              <p class="info">Category: {item.category}</p>
            </div>
  
            <div class="info-item">
              <p class="info">Region: {item.region} </p>
            </div>
  
            <div class="info-item">
              <p class="info">Seasonality: {item.seasonality}</p>
            </div>
          </div>
          
        </div> 
        
        <div class="footer-content">
          
          <div class="accordion-column">

            {recipes && recipes.length > 0 && (
              <div class="recipes-block">
                <p class="recipes-title">Recipes</p>
                <div class="recipes-content">
                  {recipes.map((recipe) => (
                    <div class="recipe-item">{recipe}</div>
                  ))}
                  <div class="recipe-item">add your recipe +</div>
                </div>
              </div>
            )}

            {item.producers && (
              <div class="producers-block">
                <p class="producers-title">Where to find it</p>

                <div class="producers-content">
                  {Array.isArray(item.producers) ? (
                    item.producers.map((producer) => (
                      <div class="producer-item">{producer}</div>
                    ))
                  ) : (
                    <p>{item.producers}</p> )}
                </div>
                </div>
            )}

          </div> 
          {item.image && <img src={item.image} alt={item.name} class="main-image" />}
        </div>

      </main>
    ) : (
      <p style="padding: 50px;">Prodotto non trovato.</p>
    )}

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Logica per l'accordion "Where to find it"
        const producersTitle = document.querySelector('.producers-title');
        const producersContent = document.querySelector('.producers-content');

        if (producersTitle && producersContent) {
          producersContent.style.display = 'none';
          producersTitle.addEventListener('click', () => {
            const isHidden = producersContent.style.display === 'none';
            producersContent.style.display = isHidden ? 'block' : 'none';
            producersTitle.classList.toggle('active', isHidden);
          });
        }

        // Logica per l'accordion "Recipes"
        const recipesTitle = document.querySelector('.recipes-title');
        const recipesContent = document.querySelector('.recipes-content');

        if (recipesTitle && recipesContent) {
          recipesContent.style.display = 'none';
          recipesTitle.addEventListener('click', () => {
            const isHidden = recipesContent.style.display === 'none';
            recipesContent.style.display = isHidden ? 'block' : 'none';
            recipesTitle.classList.toggle('active', isHidden);
          });
        }
      });
    </script>
</body>
</html>