---
// la riga in questi trattini dice all'indice quali devono essere le caratteristiche di base
import Airtable from 'airtable';

// Configura Airtable
const base = new Airtable({
  apiKey: import.meta.env.PUBLIC_AIRTABLE_API_KEY
}).base(import.meta.env.PUBLIC_AIRTABLE_BASE_ID);

// Recupera i dati
let items = [];
try {
  const records = await base(import.meta.env.PUBLIC_AIRTABLE_TABLE_NAME)
  .select({ maxRecords: 100 })
    .all();
 
  items = records.map(record => ({
    id: record.id,
    name: record.fields.Name,
    description: record.fields.Description,
    image: record.fields.Image?.[0]?.url,
    category: record.fields.Category,
    region: record.fields.Region,
    seasonality: record.fields.Seasonality,
    producers: record.fields.Producers
  }));
} catch (error) {
  console.error('Errore caricamento dati:', error);
}

// --- LOGICA PER LA DATA E L'ORA IN INGLESE ---
const now = new Date();
const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

const day = now.getDate();
const month = months[now.getMonth()];
const year = now.getFullYear();

const dataCorrente = `${day} ${month} ${year}`;
const hours = now.getHours().toString().padStart(2, '0');
const minutes = now.getMinutes().toString().padStart(2, '0');
const seconds = now.getSeconds().toString().padStart(2, '0');
const oraCorrente = `${hours}:${minutes}:${seconds}`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro</title>

    <!--test valentina -->
    
    <style>
      /* --- IMPOSTAZIONI GLOBALI --- */
      html {
        cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><circle cx='8' cy='8' r='2' fill='%23D2B48C'/><circle cx='8' cy='8' r='7' stroke='%23D2B48C' stroke-width='1' fill='none'/></svg>"), auto;
      }
      
      body {
        background-color: #3D2B1F;
        color: #d3a76e;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        line-height: 1.6; margin: 0; padding: 0; overflow-x: hidden;
      }
      body.panel-open { overflow: hidden; }

      /* --- TIPOGRAFIA --- */
      h1 {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 70px;
        font-weight: 700;
        text-align: center;
        line-height: 1.2;
        z-index: 1;
        margin: 0; padding: 0;
        color: #D2B48C;
        opacity: 1;
      }

      /* --- CONTENITORE PER LE IMMAGINI SPARSE --- */
      .image-canvas {
        position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
      }

      /* --- STILE DEL CONTENITORE 'card' --- */
      .card {
        position: absolute; width: 100px; height: 100px; overflow: hidden;
        cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease;
        z-index: 2;
      }
      .card img {
        width: 100%; height: 100%; object-fit: cover; display: block;
      }
      .card:hover {
        z-index: 10;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      
      /* --- ETICHETTE (usate nel pannello) --- */
      .category {
        display: inline-block; font-size: 0.8rem; padding: 0.2rem 0.5rem;
        border: 1px solid #D2B48C;
        margin: 0.2rem;
        color: #D2B48C;
      }
      
      /* --- FORM DI CONTRIBUTO --- */
      .contribute-section { position: fixed; bottom: 20px; right: 20px; z-index: 101; font-size: 14px; }
      .contribute-section summary {
        cursor: pointer; padding: 8px 12px; background-color: #3D2B1F;
        border: 1px solid #D2B48C; color: #D2B48C; display: inline-block;
      }
      .contribute-form {
        margin-top: 10px; padding: 20px; background-color: #3D2B1F;
        border: 1px solid #D2B48C; width: 280px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 8px; border: 1px solid #D2B48C;
        background-color: #4a3a2a; color: #D2B48C; box-sizing: border-box;
      }
      .submit-btn {
        width: 100%; padding: 10px; background-color: #D2B48C;
        color: #3D2B1F; border: none; cursor: pointer; font-size: 1em; font-weight: bold;
      }
      .submit-btn:disabled { background-color: #888; }
      .form-message { margin-top: 10px; padding: 10px; }
      .form-message.success { background-color: #e0f8e0; border: 1px solid #5cb85c; color: #333; }
      .form-message.error { background-color: #f8e0e0; border: 1px solid #d9534f; color: #333; }

      /* --- PANNELLO LATERALE --- */
      .panel-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5); z-index: 99;
        opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease;
      }
      .panel-overlay.open { opacity: 1; visibility: visible; }
      .side-panel {
        position: fixed; top: 0; right: 0; width: 50vw; height: 100vh;
        background-color: #3D2B1F; border-left: 1px solid #D2B48C;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1); z-index: 100;
        transform: translateX(100%); transition: transform 0.4s ease-in-out;
        padding: 40px; box-sizing: border-box; overflow-y: auto;
      }
      .side-panel.open { transform: translateX(0); }
      .panel-close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 28px; cursor: pointer; color: #D2B48C; }
      .panel-image { width: 100%; max-height: 40vh; object-fit: cover; margin-bottom: 20px; }
      .panel-title { font-size: 2em; margin: 0 0 10px 0; color: #D2B48C; }
      .panel-description { margin: 0 0 20px 0; }
      .panel-categories { border-top: 1px solid #5a4a3a; padding-top: 15px; }
    </style>
  </head>
  <body>
    <h1>{dataCorrente}</h1>
    
    <div class="image-canvas">
      {items.map(item => (
        <div class="card" data-id={item.id}>
          {item.image && <img src={item.image} alt={item.name} />}
        </div>
      ))}
    </div>

    <div id="panelOverlay" class="panel-overlay"></div>
    <div id="sidePanel" class="side-panel">
      <button id="closePanelBtn" class="panel-close-btn">&times;</button>
      <img id="panelImage" src="" alt="" class="panel-image" />
      <h2 id="panelTitle" class="panel-title"></h2>
      <p id="panelDescription" class="panel-description"></p>
      <div id="panelCategories" class="panel-categories"></div>
    </div>

    <details class="contribute-section">
      <summary>Vuoi contribuire all'archivio?</summary>
      <form id="contribute-form" class="contribute-form">
        <div class="form-group"><label for="title">Titolo *</label><input type="text" id="title" name="title" required /></div>
        <div class="form-group"><label for="description">Descrizione *</label><textarea id="description" name="description" rows="4" required></textarea></div>
        <div class="form-group"><label for="category">Categoria</label><select id="category" name="category"><option value="">Seleziona...</option><option value="Neri">Neri</option><option value="Siamesi">Siamesi</option><option value="Europei">Europei</option><option value="Altro">Altro</option></select></div>
        <div class="form-group"><label for="image-url">URL Immagine</label><input type="url" id="image-url" name="imageUrl" placeholder="https://esempio.com/immagine.jpg" /><small>Inserisci il link di un'immagine già online.</small></div>
        <button type="submit" class="submit-btn">Invia contributo</button>
        <div id="form-message" class="form-message"></div>
      </form>
    </details>

    <script is:inline>
      const allItems = {
        ${items.map(item => `'${item.id}': ${JSON.stringify(item)}`).join(',\n')
      };

      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.querySelector('.image-canvas');
        const cards = document.querySelectorAll('.card');
        
        if (cards.length > 0) {
            const placedItems = [];
            const maxAttemptsPerCard = 50;
            const cardWidth = 100;
            const cardHeight = 100;
            const minMargin = 20;
            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;
            
            cards.forEach(card => {
                let attempts = 0;
                let isOverlapping;
                let newCardRect;

                do {
                    const randomX = Math.random() * (canvasWidth - cardWidth);
                    const randomY = Math.random() * (canvasHeight - cardHeight);
                    newCardRect = {
                        x: randomX - minMargin, y: randomY - minMargin,
                        width: cardWidth + (minMargin * 2), height: cardHeight + (minMargin * 2)
                    };
                    isOverlapping = false;
                    for (const placedRect of placedItems) {
                        if (newCardRect.x < placedRect.x + placedRect.width &&
                            newCardRect.x + newCardRect.width > placedRect.x &&
                            newCardRect.y < placedRect.y + placedRect.height &&
                            newCardRect.y + newCardRect.height > placedRect.y) {
                            isOverlapping = true;
                            break;
                        }
                    }
                    attempts++;
                } while (isOverlapping && attempts < maxAttemptsPerCard);

                if (!isOverlapping) {
                    const finalPos = { x: newCardRect.x + minMargin, y: newCardRect.y + minMargin };
                    card.style.left = `${finalPos.x}px`;
                    card.style.top = `${finalPos.y}px`;
                    placedItems.push({ ...newCardRect, x: finalPos.x, y: finalPos.y });
                } else {
                    card.style.display = 'none';
                    console.warn('Non è stato possibile trovare uno spazio libero per una card dopo molti tentativi.');
                }
            });
        }
        
        const sidePanel = document.getElementById('sidePanel');
        const panelOverlay = document.getElementById('panelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelImage = document.getElementById('panelImage');
        const panelTitle = document.getElementById('panelTitle');
        const panelDescription = document.getElementById('panelDescription');
        const panelCategories = document.getElementById('panelCategories');

        const openPanel = (item) => {
          if (!item) return;
          panelImage.src = item.image || '';
          panelImage.alt = item.name || '';
          panelTitle.textContent = item.name || 'No Title';
          panelDescription.textContent = item.description || 'No Description';
          panelCategories.innerHTML = '';
          [item.category, item.region, item.seasonality, item.producers].filter(Boolean).forEach(cat => {
            const span = document.createElement('span');
            span.className = 'category';
            span.textContent = cat;
            panelCategories.appendChild(span);
          });
          panelOverlay.classList.add('open');
          sidePanel.classList.add('open');
          document.body.classList.add('panel-open');
        };
        const closePanel = () => {
          panelOverlay.classList.remove('open');
          sidePanel.classList.remove('open');
          document.body.classList.remove('panel-open');
        };
        cards.forEach(card => {
          card.addEventListener('click', () => {
            const itemId = card.dataset.id;
            const itemData = allItems[itemId];
            openPanel(itemData);
          });
        });
        closePanelBtn.addEventListener('click', closePanel);
        panelOverlay.addEventListener('click', closePanel);
      });
    </script>

    <script is:inline>
      document.getElementById('contribute-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('.submit-btn');
        const messageDiv = document.getElementById('form-message');
        submitBtn.disabled = true; submitBtn.textContent = 'Invio in corso...'; messageDiv.textContent = '';
        const imageUrl = document.getElementById('image-url').value.trim();
        const formData = {
          Name: document.getElementById('title').value,
          Description: document.getElementById('description').value,
          Category: document.getElementById('category').value,
        };
        if (imageUrl) { formData.Image = [{ url: imageUrl }]; }
        try {
          const response = await fetch(`https://api.airtable.com/v0/${import.meta.env.PUBLIC_AIRTABLE_BASE_ID}/${import.meta.env.PUBLIC_AIRTABLE_TABLE_NAME}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${import.meta.env.PUBLIC_AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: formData })
          });
          const responseData = await response.json();
          if (response.ok) {
            messageDiv.textContent = '✅ Contributo inviato! Ricarica la pagina per vederlo.';
            messageDiv.className = 'form-message success';
            e.target.reset();
          } else {
            messageDiv.textContent = `❌ Errore: ${responseData.error?.message || 'Errore sconosciuto'}`;
            messageDiv.className = 'form-message error';
          }
        } catch (error) {
          messageDiv.textContent = '❌ Errore di rete. Riprova.';
          messageDiv.className = 'form-message error';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Invia contributo';
        }
      });

    </script>
  </body>
</html>