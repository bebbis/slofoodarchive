---
import Airtable from 'airtable';

// Configura Airtable
const base = new Airtable({
  apiKey: import.meta.env.PUBLIC_AIRTABLE_API_KEY
}).base(import.meta.env.PUBLIC_AIRTABLE_BASE_ID);

// Recupera i dati
let items = [];
try {
  const records = await base(import.meta.env.PUBLIC_AIRTABLE_TABLE_NAME)
    .select({ maxRecords: 100 })
    .all();

  items = records.map(record => ({
    id: record.id,
    name: record.fields.Name,
    description: record.fields.Description,
    image: record.fields.Image?.[0]?.url,
    category: record.fields.Category,
    region: record.fields.Region,
    seasonality: record.fields.Seasonality,
    producers: record.fields.Producers
  }));
} catch (error) {
  console.error('Errore caricamento dati:', error);
}

// --- LOGICA PER LA DATA ---
const now = new Date();
const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
const day = now.getDate();
const month = months[now.getMonth()];
const year = now.getFullYear();
const dataCorrente = `${day} ${month} ${year}`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Archivio Stagionale</title>

    <style>
      /* --- IMPOSTAZIONI GLOBALI --- */
      html, body {
        height: 100vh;
        overflow: hidden;
      }

      html {
        cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><circle cx='8' cy='8' r='2' fill='%23D2B48C'/><circle cx='8' cy='8' r='7' stroke='%23D2B48C' stroke-width='1' fill='none'/></svg>"), auto;
      }
      
      body {
        background-color: #3D2B1F;
        color: #d3a76e;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      body.panel-open { overflow: hidden; }

      h1 {
        font-size: 70px;
        font-weight: 700;
        text-align: center;
        line-height: 1.2;
        margin: 0;
        padding: 0;
        color: #D2B48C;
      }

      h2 {
        text-align: center;
        font-weight: 400;
        margin-top: -20px;
        color: #D2B48C;
      }

      #clock {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
      }

      .image-canvas {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
        max-width: 80vw;
        max-height: 60vh;
        overflow: hidden;
        margin-top: 20px;
      }

      .card {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        opacity: 0;
        animation: fadeIn 0.8s ease forwards;
      }

      .card img {
        width: 100%; height: 100%; object-fit: cover; display: block;
      }
      .card:hover {
        z-index: 10;
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }

      @keyframes fadeIn {
        to { opacity: 1; }
      }

      .category {
        display: inline-block; font-size: 0.8rem; padding: 0.2rem 0.5rem;
        border: 1px solid #D2B48C;
        margin: 0.2rem;
        color: #D2B48C;
      }

      .contribute-section { position: fixed; bottom: 20px; right: 20px; z-index: 101; font-size: 14px; }
      .contribute-section summary {
        cursor: pointer; padding: 8px 12px; background-color: #3D2B1F;
        border: 1px solid #D2B48C; color: #D2B48C; display: inline-block;
      }
      .contribute-form {
        margin-top: 10px; padding: 20px; background-color: #3D2B1F;
        border: 1px solid #D2B48C; width: 280px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 8px; border: 1px solid #D2B48C;
        background-color: #4a3a2a; color: #D2B48C; box-sizing: border-box;
      }
      .submit-btn {
        width: 100%; padding: 10px; background-color: #D2B48C;
        color: #3D2B1F; border: none; cursor: pointer; font-size: 1em; font-weight: bold;
      }
      .submit-btn:disabled { background-color: #888; }
      .form-message { margin-top: 10px; padding: 10px; }
      .form-message.success { background-color: #e0f8e0; border: 1px solid #5cb85c; color: #333; }
      .form-message.error { background-color: #f8e0e0; border: 1px solid #d9534f; color: #333; }

      .panel-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5); z-index: 99;
        opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease;
      }
      .panel-overlay.open { opacity: 1; visibility: visible; }

      .side-panel {
        position: fixed; top: 0; right: 0; width: 50vw; height: 100vh;
        background-color: #3D2B1F; border-left: 1px solid #D2B48C;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1); z-index: 100;
        transform: translateX(100%); transition: transform 0.4s ease-in-out;
        padding: 40px; box-sizing: border-box; overflow-y: auto;
      }
      .side-panel.open { transform: translateX(0); }
      .panel-close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 28px; cursor: pointer; color: #D2B48C; }
      .panel-image { width: 100%; max-height: 40vh; object-fit: cover; margin-bottom: 20px; }
      .panel-title { font-size: 2em; margin: 0 0 10px 0; color: #D2B48C; }
      .panel-description { margin: 0 0 20px 0; }
      .panel-categories { border-top: 1px solid #5a4a3a; padding-top: 15px; }
    </style>
  </head>
  <body>
    <h1>{dataCorrente}</h1>
    <h2></h2>
    <div id="clock"></div>

    <div class="image-canvas"></div>

    <div id="panelOverlay" class="panel-overlay"></div>
    <div id="sidePanel" class="side-panel">
      <button id="closePanelBtn" class="panel-close-btn">&times;</button>
      <img id="panelImage" src="" alt="" class="panel-image" />
      <h2 id="panelTitle" class="panel-title"></h2>
      <p id="panelDescription" class="panel-description"></p>
      <div id="panelCategories" class="panel-categories"></div>
    </div>

    <details class="contribute-section">
      <summary>Vuoi contribuire all'archivio?</summary>
      <form id="contribute-form" class="contribute-form">
        <div class="form-group"><label for="title">Titolo *</label><input type="text" id="title" name="title" required /></div>
        <div class="form-group"><label for="description">Descrizione *</label><textarea id="description" name="description" rows="4" required></textarea></div>
        <div class="form-group"><label for="category">Categoria</label><select id="category" name="category"><option value="">Seleziona...</option><option value="Neri">Neri</option><option value="Siamesi">Siamesi</option><option value="Europei">Europei</option><option value="Altro">Altro</option></select></div>
        <div class="form-group"><label for="image-url">URL Immagine</label><input type="url" id="image-url" name="imageUrl" placeholder="https://esempio.com/immagine.jpg" /><small>Inserisci il link di un'immagine già online.</small></div>
        <button type="submit" class="submit-btn">Invia contributo</button>
        <div id="form-message" class="form-message"></div>
      </form>
    </details>

    <script is:inline>
      // --- CALCOLO STAGIONE ---
      function getSeason(monthIndex) {
        if (monthIndex >= 2 && monthIndex <= 4) return "Primavera";
        if (monthIndex >= 5 && monthIndex <= 7) return "Estate";
        if (monthIndex >= 8 && monthIndex <= 10) return "Autunno";
        return "Inverno";
      }
      const currentSeason = getSeason(new Date().getMonth());

      const seasonalItems = items.filter(item =>
        item.seasonality && item.seasonality.includes(currentSeason)
      );

      function getRandomItems(array, count) {
        const shuffled = [...array].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, Math.min(count, array.length));
      }
      const displayedItems = getRandomItems(seasonalItems, 8);

      const allItems = {
        ${items.map(item => `'${item.id}': ${JSON.stringify(item)}`).join(',\n')}
      };

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('h2').textContent = currentSeason;

        const imageCanvas = document.querySelector('.image-canvas');
        imageCanvas.innerHTML = '';
        displayedItems.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          card.dataset.id = item.id;
          if (item.image) {
            const img = document.createElement('img');
            img.src = item.image;
            img.alt = item.name;
            card.appendChild(img);
          }
          imageCanvas.appendChild(card);
        });

        // --- PANNELLO ---
        const sidePanel = document.getElementById('sidePanel');
        const panelOverlay = document.getElementById('panelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelImage = document.getElementById('panelImage');
        const panelTitle = document.getElementById('panelTitle');
        const panelDescription = document.getElementById('panelDescription');
        const panelCategories = document.getElementById('panelCategories');

        function openPanel(item) {
          if (!item) return;
          panelImage.src = item.image || '';
          panelImage.alt = item.name || '';
          panelTitle.textContent = item.name || 'Senza titolo';
          panelDescription.textContent = item.description || 'Nessuna descrizione disponibile.';
          panelCategories.innerHTML = '';
          [item.category, item.region, item.seasonality, item.producers].filter(Boolean).forEach(cat => {
            const span = document.createElement('span');
            span.className = 'category';
            span.textContent = cat;
            panelCategories.appendChild(span);
          });
          panelOverlay.classList.add('open');
          sidePanel.classList.add('open');
          document.body.classList.add('panel-open');
        }

        function closePanel() {
          panelOverlay.classList.remove('open');
          sidePanel.classList.remove('open');
          document.body.classList.remove('panel-open');
        }

        imageCanvas.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', () => {
            const itemId = card.dataset.id;
            const itemData = allItems[itemId];
            openPanel(itemData);
          });
        });

        closePanelBtn.addEventListener('click', closePanel);
        panelOverlay.addEventListener('click', closePanel);

        // --- OROLOGIO LIVE ---
        const clock = document.getElementById('clock');
        function updateClock() {
          const now = new Date();
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          const seconds = now.getSeconds().toString().padStart(2, '0');
          clock.textContent = `${hours}:${minutes}:${seconds}`;
        }
        updateClock();
        setInterval(updateClock, 1000);
      });
    </script>

    <script is:inline>
      document.getElementById('contribute-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('.submit-btn');
        const messageDiv = document.getElementById('form-message');
        submitBtn.disabled = true; submitBtn.textContent = 'Invio in corso...'; messageDiv.textContent = '';
        const imageUrl = document.getElementById('image-url').value.trim();
        const formData = {
          Name: document.getElementById('title').value,
          Description: document.getElementById('description').value,
          Category: document.getElementById('category').value,
        };
        if (imageUrl) { formData.Image = [{ url: imageUrl }]; }
        try {
          const response = await fetch(`https://api.airtable.com/v0/${import.meta.env.PUBLIC_AIRTABLE_BASE_ID}/${import.meta.env.PUBLIC_AIRTABLE_TABLE_NAME}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${import.meta.env.PUBLIC_AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: formData })
          });
          const responseData = await response.json();
          if (response.ok) {
            messageDiv.textContent = '✅ Contributo inviato! Ricarica la pagina per vederlo.';
            messageDiv.className = 'form-message success';
            e.target.reset();
          } else {
            messageDiv.textContent = `❌ Errore: ${responseData.error?.message || 'Errore sconosciuto'}`;
            messageDiv.className = 'form-message error';
          }
        } catch (error) {
          messageDiv.textContent = '❌ Errore di rete. Riprova.';
          messageDiv.className = 'form-message error';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Invia contributo';
        }
      });
    </script>
  </body>
</html>
